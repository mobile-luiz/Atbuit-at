<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Atbuilt - Gest√£o de Postes</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="estilos.css">
</head>
<body>


<!-- Tela de Login -->
<div id="loginContainer" class="login-container">
  <div class="login-box">
    <h2>Login</h2>
    <input type="text" id="loginEmail" placeholder="E-mail ou Usu√°rio">
    <input type="password" id="loginSenha" placeholder="Senha">
    <button onclick="fazerLogin()">Entrar</button>
    <div id="loginErro" class="login-erro"></div>
  </div>
</div>

<!-- Tela do Sistema (oculta at√© login) -->
<div id="sistemaContainer" class="sistema-container" style="display: none;">
  <div class="container">
    <h2>Atbuilt - Sistema de Gest√£o de Postes</h2>
    
    <div class="header">
      <div>
        <label for="usuario">E-mail do usu√°rio</label>
        <input type="text" id="usuario" placeholder="ex: usuario@email.com" oninput="filtrarPostes()">
      </div>

      <div>
        <label for="filtroProjeto">ID do Projeto</label>
        <select id="filtroProjeto" onchange="filtrarPostes()">
          <option value="">Todos</option>
        </select>
      </div>

      <div>
        <label for="filtroPoste">C√≥digo do Poste</label>
        <input type="text" id="filtroPoste" placeholder="ex: 9/400(E780518)" oninput="filtrarPostes()">
      </div>

         <div>
  <label for="filtroStatus">Status</label>
  <select id="filtroStatus" onchange="filtrarPostes()">
    <option value="">Todos</option>
    <option value="Em andamento">Em andamento</option>
    <option value="Conclu√≠do">Conclu√≠do</option>
  </select>
</div> 

      <div>
        <label for="dataInicial">De:</label>
        <input type="date" id="dataInicial" onchange="filtrarPostes()">
      </div>

      <div>
        <label for="dataFinal">At√©:</label>
        <input type="date" id="dataFinal" onchange="filtrarPostes()">
      </div>

      <div>
        <button onclick="filtrarPostes()">Filtrar</button>
      </div>
    </div>

 

    <div style="margin-bottom: 12px;">
     
    
  <button onclick="exportarCSV(false)">üì• Baixar P√°gina</button>
  <button onclick="exportarCSV(true)">üì• Baixar Tudo</button>

    </div>

    <div id="contadorStatus"></div>
    <div id="paginacao" style="margin: 12px 0;"></div>

  

    <div class="scroll-table">
      <div class="barra-container">
</div>
      <table id="tabelaPostes">
        <thead>
          <tr>
            <th>Data/Hora</th>
            <th>ID Projeto</th>
            <th>PG</th>
            <th>Estrutura Prim√°ria</th>
            <th>Poste Prim√°rio</th>
            <th>Poste Secund√°rio</th>
            <th>Estrutura Secund√°ria</th>
            <th>Linha Viva</th> <!-- ‚úÖ Novo -->
            <th>Servi√ßos Podas</th>
            <th>Observa√ß√µes</th>
            <th>Imagem 1</th>
            <th>Imagem 2</th>
            <th>Imagem 3</th>
            <th>Latitude</th>
            <th>Longitude</th>
            <th>Usu√°rio</th>
            <th>Status</th>
            <th>Editar</th>
            <th>Excluir</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <h3>Mapa dos Postes</h3>
    <div id="map" style="width: 100%; height: 400px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);"></div>
  </div>

<script>
  let timeoutInatividade;
  let ultimaVersaoDados = "";


  function resetarInatividade() {
    clearTimeout(timeoutInatividade);
    timeoutInatividade = setTimeout(() => {
      alert("Sess√£o expirada por inatividade.");
      localStorage.removeItem("usuarioLogado");
      localStorage.removeItem("perfilLogado");
      document.getElementById("sistemaContainer").style.display = "none";
      document.getElementById("loginContainer").style.display = "flex";
    }, 5 * 60 * 1000);
  }

  ["mousemove", "mousedown", "keydown", "touchstart"].forEach(evento => {
    document.addEventListener(evento, resetarInatividade, false);
  });

  function iniciarSessao() {
    document.getElementById("loginContainer").style.display = "none";
    document.getElementById("sistemaContainer").style.display = "block";
    carregarPostes();
    resetarInatividade();
  }

  async function fazerLogin() {
    const email = document.getElementById("loginEmail").value.trim().toLowerCase();
    const senha = document.getElementById("loginSenha").value.trim();

    if (!email || !senha) {
      document.getElementById("loginErro").innerText = "Preencha todos os campos.";
      return;
    }

    try {
      const urlLogin = "https://script.google.com/macros/s/AKfycbwN7jtkt-MKb8Q9gK1PwQgP6EyxunQ25IPLjRCJHkYeD7MmlC1wAWJ8ZjVkcsllI3ainw/exec?acao=login";
      const resposta = await fetch(urlLogin);
      const json = await resposta.json();
      const usuarios = json.dados;

      const usuarioValido = usuarios.find(u => (u.email || "").trim().toLowerCase() === email && u.senha === senha);

      if (usuarioValido) {
        localStorage.setItem("usuarioLogado", email);
        localStorage.setItem("perfilLogado", (usuarioValido.perfil || "").toLowerCase());
        iniciarSessao();
      } else {
        document.getElementById("loginErro").innerText = "Usu√°rio ou senha inv√°lidos.";
      }
    } catch (err) {
      document.getElementById("loginErro").innerText = "Erro ao verificar login.";
      console.error(err);
    }
  }

  async function carregarPostes() {
    const urlDados = "https://script.google.com/macros/s/AKfycbw15mtbx4dLzZoRTwgpDSIJ02_UnBV49ylC3cGUJBO43WrK6gmZkBiHNRWNcqampi4V1A/exec";
    const usuarioLogado = (localStorage.getItem("usuarioLogado") || "").trim().toLowerCase();
    const perfilLogado = (localStorage.getItem("perfilLogado") || "").trim().toLowerCase();

    try {
      const resposta = await fetch(urlDados);
      const json = await resposta.json();
      let dados = json.dados;

      if (perfilLogado !== "admin") {
        dados = dados.filter(p => (p.usuario || "").trim().toLowerCase() === usuarioLogado);
      }

      exibirTabela(dados);

    } catch (err) {
      alert("Erro ao carregar dados.");
      console.error(err);
    }
  }

  function exibirTabela(dados) {
    const tbody = document.querySelector("#tabelaPostes tbody");
    tbody.innerHTML = "";

    dados.forEach(p => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${p.dataHora || ""}</td>
        <td>${p.idProjeto || ""}</td>
        <td>${p.codigoPoste || ""}</td>
        <td>${p.estruturaPrimaria || ""}</td>
        <td>${p.postePrimario || ""}</td>
        <td>${p.posteSecundario || ""}</td>
        <td>${p.estruturaSecundaria || ""}</td>
        <td>${p.linhaViva || ""}</td>
        <td>${p.servicosPodas || ""}</td> <!-- ‚úÖ Campo adicionado -->
        <td>${p.observacoes || ""}</td>
        <td>${p.imagem || ""}</td>
        <td>${p.imagem2 || ""}</td>
        <td>${p.imagem3 || ""}</td>
        <td>${p.latitude || ""}</td>
        <td>${p.longitude || ""}</td>
        <td>${p.usuario || ""}</td>
        <td>${p.status || ""}</td>
        <td><button>Editar</button></td>
        <td><button>Excluir</button></td>
      `;
      tbody.appendChild(tr);
    });
  }

  window.onload = () => {
    const usuario = localStorage.getItem("usuarioLogado");
    if (usuario) {
      iniciarSessao();
    }
  };
</script>



  <script>
    const urlScript = "https://script.google.com/macros/s/AKfycbw15mtbx4dLzZoRTwgpDSIJ02_UnBV49ylC3cGUJBO43WrK6gmZkBiHNRWNcqampi4V1A/exec";
    let todosOsPostes = [];
    let paginaAtual = 1;
    const itensPorPagina = 50;
    let map;
    let markers = [];

   async function carregarPostes() {
  const usuario = document.getElementById("usuario").value.trim();
  const url = usuario ? `${urlScript}?usuario=${encodeURIComponent(usuario)}` : urlScript;

  try {
    const resposta = await fetch(url);
    const json = await resposta.json();
    let dados = json.dados;

    // Converte a dataLancamento para Date real
    dados = dados.map(p => {
      if (p.dataLancamento) {
        const partes = p.dataLancamento.split(/[\s/:]+/);
        if (partes.length >= 5) {
          const [dia, mes, ano, hora, minuto, segundo] = partes.map(Number);
          p._dataConvertida = new Date(ano, mes - 1, dia, hora, minuto, segundo || 0);
        } else {
          p._dataConvertida = null;
        }
      } else {
        p._dataConvertida = null;
      }
      return p;
    });

    // ‚ö†Ô∏è Aqui j√° ordena em ordem decrescente (mais novo primeiro)
    dados.sort((a, b) => (b._dataConvertida || 0) - (a._dataConvertida || 0));

    todosOsPostes = dados;
    popularFiltroProjetos(dados);
    paginaAtual = 1; // ‚úÖ Sempre volta para a primeira p√°gina nos novos carregamentos
    filtrarPostes();
  } catch (err) {
    alert("Erro ao carregar dados: " + err.message);
  }
}


    function popularFiltroProjetos(lista) {
      const select = document.getElementById("filtroProjeto");
      const projetosUnicos = [...new Set(lista.map(p => p.idProjeto).filter(Boolean))];
      select.innerHTML = '<option value="">Todos</option>';
      projetosUnicos.forEach(proj => {
        const opt = document.createElement("option");
        opt.value = proj;
        opt.textContent = proj;
        select.appendChild(opt);
      });
    }

    function normalizarTexto(texto) {
      return (texto || "").trim().toLowerCase();
    }


function filtrarPostes() {
  const filtroProjeto = normalizarTexto(document.getElementById("filtroProjeto")?.value);
  const filtroPoste = normalizarTexto(document.getElementById("filtroPoste")?.value);
  const filtroUsuario = normalizarTexto(document.getElementById("usuario")?.value);
  const filtroStatus = normalizarTexto(document.getElementById("filtroStatus")?.value);
  const dataInicial = document.getElementById("dataInicial").value;
  const dataFinal = document.getElementById("dataFinal").value;

  let listaFiltrada = todosOsPostes.filter(p => {
    const data = p._dataConvertida;
    return (
      (!filtroProjeto || normalizarTexto(p.idProjeto) === filtroProjeto) &&
      (!filtroPoste || normalizarTexto(p.codigoPoste).includes(filtroPoste)) &&
      (!filtroUsuario || normalizarTexto(p.usuario).includes(filtroUsuario)) &&
      (!filtroStatus || normalizarTexto(p.status) === filtroStatus) &&
      (!dataInicial || (data && data >= new Date(`${dataInicial}T00:00:00`))) &&
      (!dataFinal || (data && data <= new Date(`${dataFinal}T23:59:59`)))
    );
  });

  listaFiltrada.sort((a, b) => (b._dataConvertida || 0) - (a._dataConvertida || 0));

  const totalPaginas = Math.ceil(listaFiltrada.length / itensPorPagina);
  const inicio = (paginaAtual - 1) * itensPorPagina;
  const fim = inicio + itensPorPagina;
  const listaPaginada = listaFiltrada.slice(inicio, fim);

  exibirPostes(listaPaginada);
  mostrarMapa(listaPaginada);
  atualizarPaginacao(totalPaginas);
}



    function atualizarPaginacao(totalPaginas) {
      const pagDiv = document.getElementById("paginacao");
      pagDiv.innerHTML = "";
      for (let i = 1; i <= totalPaginas; i++) {
        const btn = document.createElement("button");
        btn.textContent = i;
        btn.style.margin = "0 4px";
        btn.disabled = (i === paginaAtual);
        btn.onclick = () => {
          paginaAtual = i;
          filtrarPostes();
        };
        pagDiv.appendChild(btn);
      }
    }

    function corrigirImagemURL(url) {
      if (!url) return "";
      if (url.includes("drive.google.com/file/d/")) {
        const match = url.match(/\/d\/([a-zA-Z0-9_-]+)\//);
        if (match && match[1]) {
          return `https://drive.google.com/uc?id=${match[1]}`;
        }
      }
      return url;
    }


   function exibirPostes(lista) {
  const tbody = document.querySelector("#tabelaPostes tbody");
  tbody.innerHTML = "";

  lista.forEach(p => {
    const tr = document.createElement("tr");
    const status = p.status || "Em andamento";
    tr.innerHTML = `
      <td><span>${p.dataLancamento || ''}</span></td>
      <td><input type="text" value="${p.idProjeto || ''}" disabled></td>
      <td><input type="text" value="${p.codigoPoste || ''}" readonly></td>
      <td><input type="text" value="${p.estruturaPrimaria || ''}" disabled></td>
      <td><input type="text" value="${p.postePrimario || ''}" disabled></td>
      <td><input type="text" value="${p.posteSecundario || ''}" disabled></td>
      <td><input type="text" value="${p.estruturaSecundaria || ''}" disabled></td>
      <td><textarea disabled>${p.linhaViva || ''}</textarea></td> <!-- ‚úÖ ALTERADO -->
        <td><textarea disabled>${p.servicosPodas || ''}</textarea></td> <!-- ‚úÖ NOVO -->
      <td><textarea disabled>${p.observacoes || ''}</textarea></td>
      <td><a href="${p.caminhoFoto}" target="_blank"><img src="${corrigirImagemURL(p.caminhoFoto)}" alt="Foto"></a></td>
      <td><a href="${p.caminhoFoto2}" target="_blank"><img src="${corrigirImagemURL(p.caminhoFoto2)}" alt="Foto2"></a></td>
     <td><a href="${p.caminhoFoto3}" target="_blank"><img src="${corrigirImagemURL(p.caminhoFoto3)}" alt="Foto3"></a></td>

      <td><input type="text" value="${p.latitude || ''}" disabled></td>
      <td><input type="text" value="${p.longitude || ''}" disabled></td>
      <td><input type="text" value="${p.usuario || ''}" readonly></td>
      <td>
        <select disabled>
          <option value="Em andamento" ${status === "Em andamento" ? "selected" : ""}>Em andamento</option>
          <option value="Conclu√≠do" ${status === "Conclu√≠do" ? "selected" : ""}>Conclu√≠do</option>
        </select>
      </td>
      <td><button onclick="editar(this)">Editar</button></td>
      <td><button onclick="excluir(this)">Excluir</button></td>
    `;
    tr.dataset.codigo = p.codigoPoste;
    tr.dataset.usuario = p.usuario;
    tbody.appendChild(tr);
  });

  // ‚úÖ Estat√≠sticas
  const totalPostes = lista.length;
  const totalProjetos = new Set(lista.map(p => p.idProjeto)).size;
  const concluidos = lista.filter(p => p.status === "Conclu√≠do").length;
  const andamento = lista.filter(p => p.status === "Em andamento").length;

const agora = new Date();
const horaAtual = agora.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
const dataAtual = agora.toLocaleDateString('pt-BR');

const mensagem = `üìä ${totalProjetos} projetos | üî¢ ${totalPostes} postes | ‚úÖ ${concluidos} conclu√≠dos | üîß ${andamento} em andamento | ${andamento > 0 ? '‚è≥ Ainda h√° postes para concluir.' : 'üéâ Todos os postes foram conclu√≠dos!'} | üïí Atualizado em: ${dataAtual} √†s ${horaAtual}`;

document.getElementById("contadorStatus").innerText = mensagem;



  mostrarMapa(lista);
}


  function editar(botao) {
  const tr = botao.closest("tr");
  const inputs = tr.querySelectorAll("input:not([readonly]), textarea, select");
  const estaEditando = botao.textContent === "Salvar";

  if (estaEditando) {
    salvar(tr);
    botao.textContent = "Editar";
    inputs.forEach(input => input.disabled = true);
  } else {
    botao.textContent = "Salvar";
    inputs.forEach(input => {
      // Protege usu√°rio e dataLancamento contra edi√ß√£o
      const colIndex = Array.from(tr.children).indexOf(input.closest("td"));
      if (colIndex !== 0 && colIndex !== 15) {
        input.disabled = false;
      }
    });
  }
}

function corrigirImagemURL(url) {
  if (!url) return "";
  const id = url.match(/[-\w]{25,}/); // ID de 25+ caracteres
  return id ? `https://drive.google.com/uc?id=${id[0]}` : url;
}

async function salvar(tr) {
  const botaoSalvar = tr.querySelector('button');
  botaoSalvar.disabled = true;
  botaoSalvar.textContent = 'Salvando...';

  const dados = {
    dataLancamento: tr.children[0]?.querySelector("span")?.innerText || "",
    idProjeto: tr.children[1].querySelector("input").value,
    codigoPoste: tr.children[2].querySelector("input").value,
    estruturaPrimaria: tr.children[3].querySelector("input").value,
    postePrimario: tr.children[4].querySelector("input").value,
    posteSecundario: tr.children[5].querySelector("input").value,
    estruturaSecundaria: tr.children[6].querySelector("input").value,
    linhaViva: tr.children[7].querySelector("textarea").value,         // ‚úÖ Linha Viva
    servicosPodas: tr.children[8].querySelector("textarea").value,     // ‚úÖ Podas
    observacoes: tr.children[9].querySelector("textarea").value,       // ‚úÖ Observa√ß√µes
    caminhoFoto: corrigirImagemURL(tr.children[10].querySelector("a")?.href || ""),
    caminhoFoto2: corrigirImagemURL(tr.children[11].querySelector("a")?.href || ""),
    caminhoFoto3: corrigirImagemURL(tr.children[12].querySelector("a")?.href || ""),
    latitude: tr.children[13].querySelector("input").value,
    longitude: tr.children[14].querySelector("input").value,
    usuario: tr.children[15].querySelector("input").value,
    status: tr.children[16].querySelector("select").value
  };


  try {
    const resposta = await fetch(urlScript, {
      method: "POST",
      body: JSON.stringify(dados)
    });

    const resultado = await resposta.json();

    if (resultado.status === "success") {
      alert("‚úÖ Poste salvo com sucesso!");
    } else {
      alert("‚ùå Erro ao salvar: " + resultado.message);
    }

  } catch (error) {
    console.error(error);
    alert("‚ùå Falha ao salvar (erro de rede).");
  }

  botaoSalvar.disabled = false;
  botaoSalvar.textContent = 'Salvar';
}

async function excluir(botao) {
  const tr = botao.closest("tr");
  const codigo = tr.dataset.codigo;

  if (!confirm("Deseja realmente excluir este poste?")) return;

  botao.disabled = true;
  botao.textContent = 'Excluindo...';

  try {
    const resposta = await fetch(`${urlScript}?acao=excluir&codigoPoste=${encodeURIComponent(codigo)}`);
    const resultado = await resposta.json();

    if (resultado.status === "success") {
      alert("‚úÖ " + resultado.message);
      tr.remove();
    } else {
      alert("‚ùå Erro: " + resultado.message);
    }

  } catch (error) {
    console.error(error);
    alert("‚ùå Falha ao excluir (erro de rede).");
  }

  botao.disabled = false;
  botao.textContent = 'Excluir';
}




   function mostrarMapa(lista) {
  const bounds = new google.maps.LatLngBounds();

map = new google.maps.Map(document.getElementById("map"), {
  zoom: 10,
  center: { lat: -8.3, lng: -35.1 },
  gestureHandling: "greedy",
  zoomControl: true,
  mapTypeControl: true,
  mapTypeControlOptions: {
    style: google.maps.MapTypeControlStyle.HORIZONTAL_BAR, // üëà Estilo lado a lado
    position: google.maps.ControlPosition.TOP_RIGHT
  },
  streetViewControl: false,
  fullscreenControl: false
});

function corrigirImagemURL(url) {
  if (!url) return "";
  const id = url.match(/[-\w]{25,}/); // Captura o ID de 25+ caracteres
  return id ? `https://drive.google.com/uc?id=${id[0]}` : "";
}



  markers.forEach(marker => marker.setMap(null));
  markers = [];

  lista.forEach(p => {
  const lat = parseFloat(p.latitude);
  const lng = parseFloat(p.longitude);

  if (!isNaN(lat) && !isNaN(lng)) {
    const marker = new google.maps.Marker({
      position: { lat, lng },
      map: map,
      icon: {
        url: 'poste.png',
        scaledSize: new google.maps.Size(36, 36)
      },
      title: `Poste: ${p.codigoPoste || ''}`
    });

    // Corrige URL da imagem
    const imagemURL = corrigirImagemURL(p.caminhoFoto);
const info = new google.maps.InfoWindow({
  content: `
    <div style="max-width: 350px; font-family: 'Roboto', sans-serif; color: #333; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.15); overflow: hidden; background: white;">
      
      <div style="background: #004d40; color: white; padding: 14px 18px; display: flex; flex-direction: column; gap: 4px;">
        <div style="font-size: 18px; font-weight: 600;">üìÅ Projeto: ${p.idProjeto || 'N/A'}</div>
        <div style="font-size: 14px; opacity: 0.9;">üîñ PG: ${p.codigoPoste || '-'}</div>
      </div>
      
      <div style="padding: 16px; display: grid; grid-template-columns: 1fr; gap: 10px; font-size: 13px;">
        <div>üìÖ <b>Data:</b> ${p.dataLancamento || '-'}</div>
        <div>üèóÔ∏è <b>Estrutura Prim√°ria:</b> ${p.estruturaPrimaria || '-'}</div>
        <div>üìç <b>Poste Prim√°rio:</b> ${p.postePrimario || '-'}</div>
        <div>üîó <b>Poste Secund√°rio:</b> ${p.posteSecundario || '-'}</div>
        <div>‚öôÔ∏è <b>Estrutura Secund√°ria:</b> ${p.estruturaSecundaria || '-'}</div>
        <div>‚ö° <b>Linha Viva:</b> ${p.linhaViva || '-'}</div>
        <div>üåø <b>Servi√ßos Podas:</b> ${p.servicosPodas || '-'}</div>
        <div>üì° <b>Lat/Lon:</b> ${p.latitude || '-'}, ${p.longitude || '-'}</div>
        <div>üü¢ <b>Status:</b> <span style="color:${p.status === 'Conclu√≠do' ? '#2e7d32' : '#ff9800'};">${p.status || 'Em andamento'}</span></div>
        <div>üë§ <b>Usu√°rio:</b> ${p.usuario || '-'}</div>
        <div>üìù <b>Observa√ß√µes:</b> ${p.observacoes || '-'}</div>
      </div>

      ${(p.caminhoFoto || p.caminhoFoto2 || p.caminhoFoto3) ? `
        <div style="padding: 12px 16px; border-top: 1px solid #eee; display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
          ${p.caminhoFoto ? `<a href="${corrigirImagemURL(p.caminhoFoto)}" target="_blank"><img src="${corrigirImagemURL(p.caminhoFoto)}" style="width: 80px; height: 80px; border-radius: 8px; object-fit: cover; border: 1px solid #ddd;" onerror='this.src="no-image.png"'></a>` : ''}
          ${p.caminhoFoto2 ? `<a href="${corrigirImagemURL(p.caminhoFoto2)}" target="_blank"><img src="${corrigirImagemURL(p.caminhoFoto2)}" style="width: 80px; height: 80px; border-radius: 8px; object-fit: cover; border: 1px solid #ddd;" onerror='this.src="no-image.png"'></a>` : ''}
          ${p.caminhoFoto3 ? `<a href="${corrigirImagemURL(p.caminhoFoto3)}" target="_blank"><img src="${corrigirImagemURL(p.caminhoFoto3)}" style="width: 80px; height: 80px; border-radius: 8px; object-fit: cover; border: 1px solid #ddd;" onerror='this.src="no-image.png"'></a>` : ''}
        </div>
      ` : ''}
    </div>
  `
});





window.abrirTabelaCompleta = function (foto1, foto2, foto3) {
  const html = `
    <html>
      <head>
        <title>Tabela Completa</title>
        <style>
          body { font-family: sans-serif; padding: 20px; display: flex; gap: 12px; flex-wrap: wrap; justify-content: center; background: #f0f0f0; }
          img { border-radius: 8px; border: 1px solid #ccc; max-width: 300px; height: auto; object-fit: contain; }
        </style>
      </head>
      <body>
        ${foto1 ? `<img src="${foto1}" onerror='this.src="no-image.png"'>` : ''}
        ${foto2 ? `<img src="${foto2}" onerror='this.src="no-image.png"'>` : ''}
        ${foto3 ? `<img src="${foto3}" onerror='this.src="no-image.png"'>` : ''}
      </body>
    </html>
  `;

  const novaJanela = window.open("", "_blank");
  novaJanela.document.write(html);
  novaJanela.document.close();
};



// ‚úÖ Fun√ß√£o para corrigir URL do Google Drive
function corrigirImagemURL(url) {
  if (!url) return "";

  const match = url.match(/\/d\/([a-zA-Z0-9_-]{25,})/);
  if (match && match[1]) {
    return `https://drive.google.com/uc?id=${match[1]}`;
  }

  return url; // Se n√£o for Drive, retorna como est√°
}
 

    // Evento ao clicar no marcador
    marker.addListener("click", () => info.open(map, marker));

    markers.push(marker);
    bounds.extend(marker.getPosition());
  }
});


  // üëâ Ajustar o centro e zoom automaticamente com base nos marcadores
  if (!bounds.isEmpty()) {
    map.fitBounds(bounds);
  }
}
function exportarCSV(tudo = false) {
const headers = [
  "Data/Hora", "ID Projeto", "Poste", "Estrutura Prim√°ria", "Poste Prim√°rio",
  "Poste Secund√°rio", "Estrutura Secund√°ria", "Linha Viva", "Servi√ßos Podas", // ‚úÖ
  "Observa√ß√µes", "Imagem 1 (URL)", "Imagem 2 (URL)", "Imagem 3 (URL)",
  "Latitude", "Longitude", "Usu√°rio", "Status"
];

  const linhas = [headers];

  let dadosParaExportar = [];

  if (tudo) {
    // Exporta todos os postes carregados no filtro (todosOsPostes global)
    dadosParaExportar = todosOsPostes;
  } else {
    // Exporta somente os exibidos na tabela atual (paginada)
    const linhasTabela = document.querySelectorAll("#tabelaPostes tbody tr");

    linhasTabela.forEach(tr => {
      const dataISO = tr.children[0]?.innerText || "";
      const dataFormatada = formatarDataBR(dataISO);

      const linha = [
        dataFormatada,
        tr.children[1]?.querySelector("input")?.value || "",
        tr.children[2]?.querySelector("input")?.value || "",
        tr.children[3]?.querySelector("input")?.value || "",
        tr.children[4]?.querySelector("input")?.value || "",
        tr.children[5]?.querySelector("input")?.value || "",
        tr.children[6]?.querySelector("input")?.value || "",
        tr.children[7]?.querySelector("input")?.value || "",
        tr.children[8]?.querySelector("textarea")?.value || "",
        tr.children[9]?.querySelector("textarea")?.value || "", // ‚úÖ Servi√ßos Podas
        tr.children[10]?.querySelector("a")?.href || "",
        tr.children[11]?.querySelector("a")?.href || "",
        tr.children[12]?.querySelector("input")?.value || "",
        tr.children[13]?.querySelector("input")?.value || "",
        tr.children[14]?.querySelector("input")?.value || "",
        tr.children[15]?.querySelector("input")?.value || "",
        tr.children[16]?.querySelector("select")?.value || ""
      ];

      linhas.push(linha);
    });
  }

  // Se for exportar tudo, monta direto do JSON original
  if (tudo) {
    dadosParaExportar.forEach(p => {
      const linha = [
        formatarDataBR(p.dataLancamento),
        p.idProjeto || "",
        p.codigoPoste || "",
        p.estruturaPrimaria || "",
        p.postePrimario || "",
        p.posteSecundario || "",
        p.estruturaSecundaria || "",
        p.linhaViva || "",
        p.servicosPodas || "", // ‚úÖ Aqui
        p.observacoes || "",
        p.caminhoFoto || "",
        p.caminhoFoto2 || "",
        p.caminhoFoto3 || "",
        p.latitude || "",
        p.longitude || "",
        p.usuario || "",
        p.status || ""
      ];
      linhas.push(linha);
    });
  }

  const csvContent = "\uFEFF" + linhas.map(l => l.map(v => `"${v}"`).join(";")).join("\n");

  const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
  const link = document.createElement("a");
  const dataHoje = new Date().toISOString().split("T")[0];
  link.href = URL.createObjectURL(blob);
  link.download = tudo ? `postes_todos_${dataHoje}.csv` : `postes_pagina_${paginaAtual}_${dataHoje}.csv`;
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}

function formatarDataBR(dataISO) {
  if (!dataISO || !dataISO.includes('T')) return dataISO;

  const dt = new Date(dataISO);
  const pad = n => n.toString().padStart(2, '0');

  return `${pad(dt.getDate())}/${pad(dt.getMonth() + 1)}/${dt.getFullYear()} ${pad(dt.getHours())}:${pad(dt.getMinutes())}:${pad(dt.getSeconds())}`;
}

async function verificarAtualizacoes() {
  try {
    const resposta = await fetch(urlScript);
    const json = await resposta.json();
    const novaVersao = JSON.stringify(json.dados);

    if (novaVersao !== ultimaVersaoDados) {
      ultimaVersaoDados = novaVersao;

      // ‚úÖ Recalcula data e reordena em ordem decrescente
      todosOsPostes = json.dados.map(p => {
        if (p.dataLancamento) {
          const partes = p.dataLancamento.split(/[\s/:]+/);
          if (partes.length >= 5) {
            const [dia, mes, ano, hora, minuto, segundo] = partes.map(Number);
            p._dataConvertida = new Date(ano, mes - 1, dia, hora, minuto, segundo || 0);
          } else {
            p._dataConvertida = null;
          }
        } else {
          p._dataConvertida = null;
        }
        return p;
      }).sort((a, b) => (b._dataConvertida || 0) - (a._dataConvertida || 0));

      // ‚úÖ Mant√©m a p√°ginaAtual que j√° est√° setada
      filtrarPostes();
      mostrarAvisoAtualizacao();
    }
  } catch (error) {
    console.error("‚ùå Erro ao verificar atualiza√ß√µes:", error);
  }
}



function mostrarAvisoAtualizacao() {
  let aviso = document.getElementById("avisoAtualizacao");

  if (!aviso) {
    aviso = document.createElement("div");
    aviso.id = "avisoAtualizacao";
    aviso.style.position = "fixed";
    aviso.style.top = "0";
    aviso.style.left = "0";
    aviso.style.right = "0";
    aviso.style.background = "#1976d2";
    aviso.style.color = "white";
    aviso.style.padding = "10px";
    aviso.style.textAlign = "center";
    aviso.style.zIndex = "9999";
    aviso.style.fontWeight = "bold";
    aviso.textContent = "üîÑ Dados atualizados com sucesso";
    document.body.appendChild(aviso);

    setTimeout(() => {
      aviso.remove();
    }, 3000);
  }
}


window.onload = () => {
  carregarPostes();  // Primeira carga normal
  setInterval(verificarAtualizacoes, 15000);  // Verifica a cada 15s
};



   // window.onload = () => carregarPostes();
   // setInterval(() => carregarPostes(), 15000);
  </script>
  <script async defer
  src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDP1sgTUcHF3ULf9ezZNRbjj2RN-2uNtRQ&callback=initMap">

  </script>
  <script>
    function initMap() {}
  </script>
</body>
</html>
